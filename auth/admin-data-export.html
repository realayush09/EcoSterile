<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Data Export - EcoSterile Admin</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);
            color: #f1f5f9;
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 40px;
            padding-bottom: 20px;
            border-bottom: 1px solid rgba(16, 185, 129, 0.1);
        }

        .header-left h1 {
            font-size: 2rem;
            margin-bottom: 5px;
            background: linear-gradient(135deg, #ef4444 0%, #f97316 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .header-left p {
            color: #64748b;
            font-size: 0.9rem;
        }

        .back-btn {
            padding: 10px 20px;
            background: rgba(16, 185, 129, 0.2);
            border: 1px solid rgba(16, 185, 129, 0.5);
            color: #86efac;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
            text-decoration: none;
        }

        .back-btn:hover {
            background: rgba(16, 185, 129, 0.3);
            transform: translateY(-2px);
        }

        .status-message {
            padding: 15px 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            display: none;
            animation: slideIn 0.3s ease;
        }

        .status-message.error {
            background: rgba(239, 68, 68, 0.1);
            border: 1px solid rgba(239, 68, 68, 0.3);
            color: #fca5a5;
            display: block;
        }

        .status-message.success {
            background: rgba(16, 185, 129, 0.1);
            border: 1px solid rgba(16, 185, 129, 0.3);
            color: #86efac;
            display: block;
        }

        .status-message.info {
            background: rgba(59, 130, 246, 0.1);
            border: 1px solid rgba(59, 130, 246, 0.3);
            color: #93c5fd;
            display: block;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .export-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .export-card {
            background: rgba(30, 41, 59, 0.8);
            border: 1px solid rgba(16, 185, 129, 0.1);
            border-radius: 12px;
            padding: 30px;
            transition: all 0.3s ease;
        }

        .export-card:hover {
            border-color: #10b981;
            box-shadow: 0 10px 25px rgba(16, 185, 129, 0.15);
            transform: translateY(-4px);
        }

        .export-icon {
            font-size: 2.5rem;
            margin-bottom: 15px;
        }

        .export-title {
            font-size: 1.2rem;
            font-weight: 600;
            margin-bottom: 10px;
            color: #f1f5f9;
        }

        .export-desc {
            color: #cbd5e1;
            font-size: 0.85rem;
            margin-bottom: 20px;
            line-height: 1.5;
        }

        .export-stats {
            background: rgba(15, 23, 42, 0.5);
            border-radius: 6px;
            padding: 12px;
            margin-bottom: 15px;
            font-size: 0.85rem;
            color: #10b981;
        }

        .export-btn {
            width: 100%;
            padding: 12px;
            background: #10b981;
            border: none;
            border-radius: 8px;
            color: white;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .export-btn:hover:not(:disabled) {
            background: #059669;
            transform: translateY(-2px);
        }

        .export-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .loading-spinner {
            display: inline-block;
            width: 14px;
            height: 14px;
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-top-color: white;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }

        .stats-overview {
            background: rgba(30, 41, 59, 0.8);
            border: 1px solid rgba(16, 185, 129, 0.1);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 30px;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
        }

        .stat-item {
            background: rgba(15, 23, 42, 0.5);
            padding: 15px;
            border-radius: 8px;
            border-left: 3px solid #10b981;
        }

        .stat-label {
            color: #cbd5e1;
            font-size: 0.85rem;
            margin-bottom: 5px;
        }

        .stat-value {
            font-size: 1.5rem;
            font-weight: 700;
            color: #10b981;
        }

        .security-info {
            background: rgba(239, 68, 68, 0.05);
            border-left: 3px solid #ef4444;
            padding: 15px;
            border-radius: 4px;
            margin-top: 30px;
            color: #cbd5e1;
            font-size: 0.85rem;
            line-height: 1.6;
        }

        .security-info strong {
            color: #ef4444;
        }

        .section-title {
            font-size: 1.5rem;
            margin-bottom: 20px;
            color: #f1f5f9;
        }

        @media (max-width: 768px) {
            .export-grid {
                grid-template-columns: 1fr;
            }

            .header {
                flex-direction: column;
                gap: 20px;
                align-items: flex-start;
            }

            .back-btn {
                align-self: flex-end;
            }
        }
    </style>
</head>

<body>
    <div class="container">
        <!-- Header -->
        <div class="header">
            <div class="header-left">
                <h1>üìä Data Export Center</h1>
                <p id="adminEmail">Admin Email</p>
            </div>
            <a href="admin-dashboard.html" class="back-btn">‚Üê Back to Dashboard</a>
        </div>

        <!-- Status Messages -->
        <div id="statusMessage" class="status-message"></div>

        <!-- Statistics Overview -->
        <div class="stats-overview">
            <div class="section-title">üìà Database Statistics</div>
            <div class="stats-grid">
                <div class="stat-item">
                    <div class="stat-label">Total Users</div>
                    <div class="stat-value" id="statsUsers">-</div>
                </div>
                <div class="stat-item">
                    <div class="stat-label">PH Readings</div>
                    <div class="stat-value" id="statsReadings">-</div>
                </div>
                <div class="stat-item">
                    <div class="stat-label">Pump Logs</div>
                    <div class="stat-value" id="statsPumps">-</div>
                </div>
                <div class="stat-item">
                    <div class="stat-label">Total Data Points</div>
                    <div class="stat-value" id="statsTotal">-</div>
                </div>
            </div>
        </div>

        <!-- Export Options -->
        <div>
            <div class="section-title">üì• Export Formats</div>

            <div class="export-grid">
                <!-- JSON Complete -->
                <div class="export-card">
                    <div class="export-icon">üìã</div>
                    <div class="export-title">Complete JSON</div>
                    <div class="export-desc">Full nested structure with all data including all PH readings and pump logs
                    </div>
                    <div class="export-stats">
                        <div id="statsJson">Preparing...</div>
                    </div>
                    <button class="export-btn" id="exportJsonBtn" disabled>
                        <span id="jsonBtnText">Download JSON</span>
                    </button>
                </div>

                <!-- NDJSON (ML Ready) -->
                <div class="export-card">
                    <div class="export-icon">ü§ñ</div>
                    <div class="export-title">ML Training Data (NDJSON)</div>
                    <div class="export-desc">Newline Delimited JSON format optimized for machine learning frameworks
                    </div>
                    <div class="export-stats">
                        <div id="statsNdjson">Preparing...</div>
                    </div>
                    <button class="export-btn" id="exportNdjsonBtn" disabled>
                        <span id="ndjsonBtnText">Download NDJSON</span>
                    </button>
                </div>

                <!-- CSV Readings -->
                <div class="export-card">
                    <div class="export-icon">üìä</div>
                    <div class="export-title">Readings CSV</div>
                    <div class="export-desc">All sensor readings as individual rows - one per reading event</div>
                    <div class="export-stats">
                        <div id="statsReadingsCsv">Preparing...</div>
                    </div>
                    <button class="export-btn" id="exportCsvBtn" disabled>
                        <span id="csvBtnText">Download CSV</span>
                    </button>
                </div>

                <!-- Flattened JSON -->
                <div class="export-card">
                    <div class="export-icon">üîÑ</div>
                    <div class="export-title">Flattened JSON</div>
                    <div class="export-desc">User-centered format with readings arrays for easier processing</div>
                    <div class="export-stats">
                        <div id="statsFlattened">Preparing...</div>
                    </div>
                    <button class="export-btn" id="exportFlattenedBtn" disabled>
                        <span id="flattenedBtnText">Download Flattened</span>
                    </button>
                </div>
            </div>
        </div>

        <!-- Security Info -->
        <div class="security-info">
            <strong>üîí Security & Privacy Notice:</strong><br>
            ‚Ä¢ All exports are generated client-side in your browser<br>
            ‚Ä¢ No data is sent to external servers<br>
            ‚Ä¢ Each export is timestamped for audit purposes<br>
            ‚Ä¢ Admin actions are logged in Firebase<br>
            ‚Ä¢ File sizes may be 1-5 MB depending on data volume<br>
            ‚Ä¢ GDPR compliant - all PII is included as per your data structure
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-app.js";
        import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-auth.js";
        import { getDatabase, ref, get } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-database.js";

        // Firebase Config
        const firebaseConfig = {
            apiKey: "AIzaSyA6G8DgCBqA9lFMlKfGIC_JCEaZU-GuPxs",
            authDomain: "eco-sterile.firebaseapp.com",
            databaseURL: "https://eco-sterile-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "eco-sterile",
            storageBucket: "eco-sterile.firebasestorage.app",
            messagingSenderId: "429228597840",
            appId: "1:429228597840:web:45c0f163c578480fc2a755",
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getDatabase(app);

        let currentUser = null;
        let allData = null;

        // DOM Elements
        const adminEmailEl = document.getElementById('adminEmail');
        const statusMsg = document.getElementById('statusMessage');
        const exportBtns = {
            json: document.getElementById('exportJsonBtn'),
            ndjson: document.getElementById('exportNdjsonBtn'),
            csv: document.getElementById('exportCsvBtn'),
            flattened: document.getElementById('exportFlattenedBtn')
        };
        const btnTexts = {
            json: document.getElementById('jsonBtnText'),
            ndjson: document.getElementById('ndjsonBtnText'),
            csv: document.getElementById('csvBtnText'),
            flattened: document.getElementById('flattenedBtnText')
        };

        // Auth Check
        onAuthStateChanged(auth, async (user) => {
            if (!user) {
                window.location.href = "admin-login.html";
                return;
            }

            currentUser = user;
            adminEmailEl.textContent = `üë§ ${user.email}`;

            // Load data
            await loadData();
        });

        // Load all data from Firebase
        async function loadData() {
            try {
                showStatus("Loading database...", "info");

                const dbRef = ref(db, '/');
                const snapshot = await get(dbRef);
                allData = snapshot.val();

                updateStats();
                enableAllButtons();
                showStatus("‚úÖ Database loaded successfully", "success");
            } catch (error) {
                console.error("Error loading data:", error);
                showStatus("‚ùå Error loading database: " + error.message, "error");
            }
        }

        // Update statistics
        function updateStats() {
            if (!allData || !allData.users) return;

            const users = allData.users;
            let totalReadings = 0;
            let totalPumps = 0;

            Object.values(users).forEach(user => {
                if (user.phReadings) totalReadings += Object.keys(user.phReadings).length;
                if (user.pumpLogs) totalPumps += Object.keys(user.pumpLogs).length;
            });

            const totalUsers = Object.keys(users).length;
            const totalPoints = totalReadings + totalPumps;

            document.getElementById('statsUsers').textContent = totalUsers;
            document.getElementById('statsReadings').textContent = totalReadings.toLocaleString();
            document.getElementById('statsPumps').textContent = totalPumps.toLocaleString();
            document.getElementById('statsTotal').textContent = totalPoints.toLocaleString();

            // Update card stats
            document.getElementById('statsJson').textContent = `‚âà ${(calculateJsonSize(users) / 1024 / 1024).toFixed(2)} MB`;
            document.getElementById('statsNdjson').textContent = `${totalUsers} users, ${totalReadings + totalPumps} events`;
            document.getElementById('statsReadingsCsv').textContent = `${totalReadings + totalPumps} rows`;
            document.getElementById('statsFlattened').textContent = `${totalUsers} users with arrays`;
        }

        // Calculate JSON size estimate
        function calculateJsonSize(users) {
            return JSON.stringify(users).length;
        }

        // Enable all buttons
        function enableAllButtons() {
            Object.values(exportBtns).forEach(btn => {
                btn.disabled = false;
                btn.style.opacity = "1";
                btn.style.cursor = "pointer";
            });
        }

        // Export functions
        exportBtns.json.addEventListener('click', () => exportJSON(allData.users));
        exportBtns.ndjson.addEventListener('click', () => exportNDJSON(allData.users));
        exportBtns.csv.addEventListener('click', () => exportCSV(allData.users));
        exportBtns.flattened.addEventListener('click', () => exportFlattened(allData.users));

        // Export JSON
        async function exportJSON(users) {
            try {
                setButtonLoading('json', true);
                const data = users;
                const timestamp = new Date().toISOString().replace(/[:.]/g, '-');
                const filename = `ecosterile-complete-${timestamp}.json`;

                const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
                downloadFile(blob, filename);

                showStatus(`‚úÖ Exported ${Object.keys(users).length} users as JSON`, "success");
                setButtonLoading('json', false);
            } catch (error) {
                showStatus("‚ùå Export failed: " + error.message, "error");
                setButtonLoading('json', false);
            }
        }

        // Export NDJSON
        async function exportNDJSON(users) {
            try {
                setButtonLoading('ndjson', true);
                let ndjson = '';

                Object.entries(users).forEach(([userId, userData]) => {
                    const record = {
                        userId,
                        profile: userData.profile || {},
                        location: userData.location || {},
                        settings: userData.settings || {},
                        phReadings: userData.phReadings ? Object.values(userData.phReadings) : [],
                        pumpLogs: userData.pumpLogs ? Object.values(userData.pumpLogs) : []
                    };
                    ndjson += JSON.stringify(record) + '\n';
                });

                const timestamp = new Date().toISOString().replace(/[:.]/g, '-');
                const filename = `ecosterile-ml-${timestamp}.ndjson`;

                const blob = new Blob([ndjson], { type: 'text/plain' });
                downloadFile(blob, filename);

                showStatus(`‚úÖ Exported ML training data (NDJSON)`, "success");
                setButtonLoading('ndjson', false);
            } catch (error) {
                showStatus("‚ùå Export failed: " + error.message, "error");
                setButtonLoading('ndjson', false);
            }
        }

        // Export CSV
        async function exportCSV(users) {
            try {
                setButtonLoading('csv', true);
                let csv = 'userId,userName,email,dataType,timestamp,value,country,state,district\n';

                Object.entries(users).forEach(([userId, userData]) => {
                    const profile = userData.profile || {};
                    const location = userData.location || {};

                    // PH Readings
                    if (userData.phReadings) {
                        Object.values(userData.phReadings).forEach(reading => {
                            csv += `${userId},"${profile.name || ''}","${profile.email || ''}",PHReading,"${reading.timestamp || ''}",${reading.value || ''},"${location.country || ''}","${location.state || ''}","${location.district || ''}"\n`;
                        });
                    }

                    // Pump Logs
                    if (userData.pumpLogs) {
                        Object.values(userData.pumpLogs).forEach(log => {
                            csv += `${userId},"${profile.name || ''}","${profile.email || ''}",PumpLog,"${log.timestamp || ''}","${log.status || log.pumpedAmount || ''}","${location.country || ''}","${location.state || ''}","${location.district || ''}"\n`;
                        });
                    }
                });

                const timestamp = new Date().toISOString().replace(/[:.]/g, '-');
                const filename = `ecosterile-readings-${timestamp}.csv`;

                const blob = new Blob([csv], { type: 'text/csv' });
                downloadFile(blob, filename);

                showStatus(`‚úÖ Exported all readings as CSV`, "success");
                setButtonLoading('csv', false);
            } catch (error) {
                showStatus("‚ùå Export failed: " + error.message, "error");
                setButtonLoading('csv', false);
            }
        }

        // Export Flattened
        async function exportFlattened(users) {
            try {
                setButtonLoading('flattened', true);
                const data = [];

                Object.entries(users).forEach(([userId, userData]) => {
                    data.push({
                        userId,
                        profile: userData.profile || {},
                        location: userData.location || {},
                        settings: userData.settings || {},
                        phReadings: userData.phReadings ? Object.values(userData.phReadings) : [],
                        pumpLogs: userData.pumpLogs ? Object.values(userData.pumpLogs) : []
                    });
                });

                const timestamp = new Date().toISOString().replace(/[:.]/g, '-');
                const filename = `ecosterile-flattened-${timestamp}.json`;

                const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
                downloadFile(blob, filename);

                showStatus(`‚úÖ Exported flattened user data`, "success");
                setButtonLoading('flattened', false);
            } catch (error) {
                showStatus("‚ùå Export failed: " + error.message, "error");
                setButtonLoading('flattened', false);
            }
        }

        // Helper functions
        function downloadFile(blob, filename) {
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        function showStatus(message, type) {
            statusMsg.textContent = message;
            statusMsg.className = `status-message ${type}`;
        }

        function setButtonLoading(type, loading) {
            if (loading) {
                exportBtns[type].disabled = true;
                btnTexts[type].innerHTML = '<span class="loading-spinner"></span> Exporting...';
            } else {
                exportBtns[type].disabled = false;
                const texts = {
                    json: 'Download JSON',
                    ndjson: 'Download NDJSON',
                    csv: 'Download CSV',
                    flattened: 'Download Flattened'
                };
                btnTexts[type].textContent = texts[type];
            }
        }
    </script>
</body>

</html>